name: ğŸšŒ Build Android APK

on:
  push:
    branches: [ main ]
    paths:
      - 'android-wrapper/**'
      - 'web/**'
      - '.github/workflows/build-apk.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“¦ Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: '8.2'
        
    - name: ğŸ”¨ Build Debug APK
      working-directory: ./android-wrapper
      run: |
        gradle wrapper
        ./gradlew assembleDebug --stacktrace
      
    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: android-wrapper/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ğŸ“‹ Build Info
      run: |
        echo "âœ… APK ÑĞ¾Ğ±Ñ€Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
        echo ""
        echo "ğŸ“± Debug APK Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ…"
        echo "ğŸ”— Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ: Actions â†’ Build Android APK â†’ Artifacts"

  build-release:
    runs-on: ubuntu-latest
    needs: build-apk
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“¦ Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: '8.2'
        
    - name: ğŸ” Decode Keystore
      env:
        ENCODED_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [ -n "$ENCODED_KEYSTORE" ]; then
          echo "$ENCODED_KEYSTORE" | base64 -d > android-wrapper/app/keystore.jks
          echo "âœ… Keystore Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½"
        else
          echo "âš ï¸ Keystore Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½, Ğ±ÑƒĞ´ĞµÑ‚ Ğ½ĞµĞ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°"
        fi
      
    - name: ğŸ”¨ Build Release APK
      working-directory: ./android-wrapper
      run: |
        gradle wrapper
        if [ -f app/keystore.jks ]; then
          ./gradlew assembleRelease --stacktrace
        else
          ./gradlew assembleRelease --stacktrace
        fi
      
    - name: ğŸ“¤ Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release-apk
        path: android-wrapper/app/build/outputs/apk/release/*.apk
        retention-days: 90
        
    - name: ğŸ“ Create Release Notes
      run: |
        echo "# ğŸšŒ ĞĞ²Ñ‚Ğ¾Ğ±ÑƒÑÑ‹ ĞĞ»Ñ‘ĞºĞ¼Ğ¸Ğ½ÑĞº â€” Android APK" > release-notes.md
        echo "" >> release-notes.md
        echo "## Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: $(date '+%Y-%m-%d %H:%M')" >> release-notes.md
        echo "" >> release-notes.md
        echo "### Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:" >> release-notes.md
        echo "- $(git log -1 --pretty=format:'%s')" >> release-notes.md
        echo "" >> release-notes.md
        echo "### Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°:" >> release-notes.md
        echo '1. Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹Ñ‚Ğµ APK Ğ¸Ğ· Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ¾Ğ²' >> release-notes.md
        echo '2. Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸Ğ· Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ²"' >> release-notes.md
        echo '3. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ APK' >> release-notes.md
        
    - name: ğŸ“¤ Upload Release Notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: release-notes.md

  notify:
    runs-on: ubuntu-latest
    needs: [build-apk, build-release]
    if: always()
    
    steps:
    - name: âœ… Success
      if: needs.build-apk.result == 'success' && needs.build-release.result == 'success'
      run: |
        echo "ğŸ‰ APK ÑĞ¾Ğ±Ñ€Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
        echo ""
        echo "ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ:"
        echo "  - Debug: Actions â†’ Build Android APK â†’ Artifacts â†’ app-debug-apk"
        echo "  - Release: Actions â†’ Build Android APK â†’ Artifacts â†’ app-release-apk"
        
    - name: âŒ Failed
      if: needs.build-apk.result == 'failure' || needs.build-release.result == 'failure'
      run: |
        echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸ APK"
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ² Actions"
        exit 1
